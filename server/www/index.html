<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

  <style>
    .container {
      width: 700px ;
      margin-left: auto ;
      margin-right: auto ;
      padding-top: 10%;
    }
  </style>
</head>
<body>
<div id="app">
  <v-app id="inspire">
    <v-navigation-drawer v-model="drawer" app clipped>
      <v-list dense>
        <v-list-item link>
          <v-list-item-action>
            <v-icon>mdi-view-dashboard</v-icon>
          </v-list-item-action>
          <v-list-item-content>
            <v-list-item-title>Dashboard</v-list-item-title>
          </v-list-item-content>
        </v-list-item>
        <v-list-item link>
          <v-list-item-action>
            <v-icon>mdi-settings</v-icon>
          </v-list-item-action>
          <v-list-item-content>
            <v-list-item-title>Settings</v-list-item-title>
          </v-list-item-content>
        </v-list-item>
      </v-list>
    </v-navigation-drawer>

    <v-app-bar app clipped-left>
      <v-app-bar-nav-icon @click.stop="drawer = !drawer" />
      <v-toolbar-title>Application</v-toolbar-title>
    </v-app-bar>

    <v-content>
      <v-container class="fill-height" fluid>

        <v-row align="center" justify="center">
          {{lastMessage}}
        </v-row>

        <v-row align="center" justify="center">
          <line-chart :chart-data="chartData"></line-chart>
        </v-row>

      </v-container>
    </v-content>

    <v-footer app>
      <span>&copy; 2019</span>
    </v-footer>
  </v-app>
</div>

<script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js"></script>
<script src="https://unpkg.com/vue-chartjs/dist/vue-chartjs.min.js"></script>

<script>

    Vue.component('line-chart', {
        extends: VueChartJs.Line,
        mixins: [VueChartJs.mixins.reactiveProp],
        data: function () {
            return {
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            },
                            gridLines: {
                                display: true
                            }
                        }],
                        xAxes: [{
                            ticks: {
                                beginAtZero: true
                            },
                            gridLines: {
                                display: false
                            }
                        }]
                    },
                    legend: {
                        display: true
                    },
                    tooltips: {
                        enabled: true,
                        mode: 'single',
                        callbacks: {
                            label: function(tooltipItems, data) {
                                return '$' + tooltipItems.yLabel;
                            }
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    height: 200
                }
            }
        },
        mounted () {
            this.renderChart(this.chartData, this.options)
        }
    })


    const app = new Vue({
      el: '#app',
      vuetify: new Vuetify(),
      props: {
        source: String,
      },
      data: () => ({
        drawer: null,
        lastMessage: 'Hi there',

        // this is bound to the chart above in the html line-chart element
        chartData: {
          labels: [],
          datasets: [
            {
              label: 'Client Messages',
              backgroundColor: '#f87979',
              borderColor:  '#f87979',
              data: [],
              fill: false,
            }
          ]
        },
      }),
      created () {
        this.$vuetify.theme.dark = true;
      },
      methods: {
        addData: (label, value) => {
          app.chartData.labels.push(label);
          app.chartData.datasets[0].data.push(value);
          // it won't pick up the dynamic stuff we added unless we assign app.chartData to a new object
          app.chartData = {...app.chartData}
        },
      }
    });



    const socket = io();
    socket.on('connect', function() {
        console.log('connected to socket server');
        socket.on('clientMessage', function(data) {
            console.log('received clientMessage: ' + JSON.stringify(data));
            app.lastMessage = JSON.stringify(data);
            app.addData(data.msg.time, data.msg.count);
        });

        socket.on('heartbeat', function(data) {
            console.log('received heartbeat: ' + JSON.stringify(data));
        });

    });

    socket.on('disconnect', function() {
        console.log('disconnected from socket server');
    });

</script>
</body>

</html>
